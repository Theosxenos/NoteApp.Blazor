@inject NotebookService NbSvc;
@inject NotesService NtSvc;

<nav class="navbar">
	<div class="container-fluid">
		<a href="#" class="navbar-brand">Notes</a>
		<button class="btn btn-outline-primary" @onclick="NewNote">New note</button>
		@* <button class="btn btn-outline-secondary">New to-do</button> *@
		<div class="d-flex" role="search">
			<input type="text" class="form-control form-control-sm me-2" @bind="@SearchTerm">
			<button class="btn btn-outline-success" @onclick="SearchNotes">Search</button>
		</div>
	</div>
</nav>
<div class="list-group">
	@if(NbSvc.ActiveNotebook is not null)
	{
		@foreach (var note in NtSvc.GetNotesFromNotebook(NbSvc.ActiveNotebook.NotebookId))
		{
			<a href="#" class="list-group-item @(note.NoteId == NtSvc.ActiveNote.NoteId ? "active" : "")" @onclick="() => OnNoteClick(note)">@note.Name</a>
		}
	} 
	else
	{
		<p>Waiting...</p>
	}
</div>


@code {
	//TODO For testing purposes only
	int lastid = -1;
	string SearchTerm { get; set; }

	protected override void OnInitialized()
	{
		NbSvc.ActiveNotebookChanged += InvokeStateHasChanged;
		NtSvc.NotePropertiesChanged += InvokeStateHasChanged;;
	}

	private async void InvokeStateHasChanged()
	{
		await InvokeAsync(StateHasChanged);
	}

	// private async void OnActiveNotebookChanged(object? sender, EventArgs e)
	// {
	// 	await InvokeAsync(StateHasChanged);
	// 	// NtSvc.SetActiveNote();
	// }

	void NewNote()
	{
		var note = new Note()
		{
			NoteId = ++lastid,
			Name = $"Test {new Random().Next()}",
			Content = $"Test content {new Random().Next()}",
			NotebookId = NbSvc.ActiveNotebook.NotebookId
		};
		NtSvc.CreateNote(note);
	}

	private void OnNoteClick(Note note)
	{
		NtSvc.SetActiveNote(note.NoteId);
		// OnActiveChanged(null, EventArgs.Empty);
	}
	private void SearchNotes()
	{
		NtSvc.SearchNote(SearchTerm);
	}

}
